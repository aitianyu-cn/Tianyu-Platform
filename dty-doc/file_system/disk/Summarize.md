# 天宇文件系统概述

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;天宇文件系统（TYFS）由<b>天宇磁盘分区表（TianyuPartitionTable）</b>和<b>天宇分区格式（TianyuPartitionFormat）</b>两部分组成。TYFS的主要目的是解决磁盘分区的动态扩充问题，并解决文件结构安全的问题，既保证磁盘数据的**逻辑安全**，又能提供**空间扩充**的能力。  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了提供逻辑数据安全和空间扩充能力，因此对于每一个TYPF都将使用<b>2%\-5%</b>的空间用于保存**安全性数据**。  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面将对整个TYFS进行具体的说明。  
+ **TYPT**   
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;天宇文件系统中，为了提供磁盘分区自动扩展的能力，因此单独为磁盘设计了新的分区表：TYPT。TYPT与GPT类似，使用GUID对磁盘和磁盘分区进行标识，并提供备份。下面将针对具体的结构进行说明。  
  
> **TYPT结构**  
> |项目|ID|说明|
> |:-:|:-:|:--|
> |保护MBR|LBA0|MBR分区表，寻址0Byte大小磁盘，用于保护当前磁盘|
> |主TYPT|LBA1|TYFS的主要TYPT分区表，用于提供128组磁盘分区信息项目，每个信息项目采用GUID标识，同时标识当前磁盘分区格式（当前只可标识TYPF）和联合磁盘的状态；（针对联合磁盘核心盘<font color=red>\[第一个盘\]</font>）还提供了附加的联合分区信息|
> |DATA段|LBA2|TYFS的所有数据段|
> |备份TYPT|LBA3|TYFS的备份TYPT分区表，与**主TYPT分区表**相同|  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 

> **TYPT详细结构**
>> ***保护MBR***  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;保护MBR用于保护当前磁盘TYFS文件系统的安全，防止不支持的程序修改TYFS文件系统引发系统错误。同时为了提高访问效率，保护MBR将占用4KB大小。保护MBR段的4KB不仅包含MBR分区表，还包含**TYPT分区表的分区信息描述头**。以下为MBR区的512字节扇区。
>> ```
>> Offset        0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF
>> 0000000000   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000010   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000020   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000030   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000050   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000060   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000070   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000080   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000090   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000000A0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000000B0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000000C0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000000D0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000000E0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000000F0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000100   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000110   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000120   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000130   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000140   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000150   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000160   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000170   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000180   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 0000000190   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000001A0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000001B0   00 00 00 00 00 00 54 00 59 00 50 00 54 00 00 00  ......T.Y.P.T...
>> 00000001C0   00 00 0B 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000001D0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000001E0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
>> 00000001F0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 AA  ..............U.
>> ```
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在TYFS驱动程序上，通过读取0x00000001B6开始的8字节，并与`T.Y.P.T.`进行比对，成功则该磁盘为TYFS分区系统磁盘。
>> 
>> ***主TYPT***  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPT部分包含**TYPT信息表**与**TYPT分区表**。TYPT信息表用于标识当前磁盘的基本信息、容量等信息，如下表为对应**字段**、**大小**与**说明**。
>> |字段|大小|说明|
>> |:-:|:-:|:--|
>> |TYPT头|8字节|值为`T.Y.P.T.`，用于表示当前分区表为TYPT分区表|
>> |版本|4字节|当前值为`{0x01,0x00,0x00,0x00}`，后期可用于升级后的版本区分|
>> |磁盘GUID|16字节|用于标识当前磁盘|
>> |扇区开始扇区号|8字节|用于标识当前磁盘可用部分的开始扇区号|
>> |扇区结束扇区号|8字节|用于标识当前磁盘可用部分的结束扇区号|
>> |扇区总数|8字节|用于标识当前磁盘可用部分的总扇区数|  
>> 
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当前TYPT信息区部分只使用52Bytes的块，之后的部分自动填充0x00。
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPT信息表之后就是TYPT分区表，分区表总共包含128个项，当前可用于128个TYPF分区（在之后的更新中将支持更多的常用分区类型），如下表为对应**字段**、**大小**与**说明**。
>> |字段|大小|说明|
>> |:-:|:-:|:--|
>> |分区类型|16字节|该项目为空时分区不可用，建立分区后与**分区GUID**相同值，联合分区时使用联合分区特有ID|
>> |分区GUID|16字节|当前分区的唯一标识符|
>> |开始扇区号|8字节|当前分区的开始扇区号|
>> |结束扇区号|8字节|当前分区的结束扇区号|
>> |分区属性|8字节|当前分区的附加属性（包含隐藏状态、簇大小、联合状态等）|
>> |分区名称|72字节|用于标识当前分区的名称|
>> 
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当前TYPT分区表使用128Bytes用于标识一项，总共使用128项，共16KB大小。
>> 
>> ***DATA段***  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPT的数据段当前只能从第32KB偏移量处开始，并在-32KB处结束（磁盘最后32KB为备份TYPT，包含完整的TYPT分区表以及MBR块）。
>> 
>> ***备份TYPT***  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;备份TYPT包含LBA0与LBA1的全部信息，占据相同的32KB大小。
>> 

+ **TYPF**  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPF是天宇文件系统中实现分区动态可拓展性和逻辑安全性的实现部分，TYPF借鉴NTFS的文件记录方式，提供以MFR（Main Files Record）为文件系统框架的文件系统。分区采用48bit寻址大小，分为高16字节和低32字节。高16字节用于标识分区，低32字节用于标识分区内的块号。
> ***分区标识***  
>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分区标识用于记录TYPF的开始，以`T.Y.P.F.`为标识，占用8字节的控件。  

> ***分区信息***  
>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分区信息用于记录TYPF的文件部分位置，包含信息如下表。 
>> |字段|大小|说明|
>> |:-:|:-:|:--|
>> |分区实际起始扇区号|8字节|当前分区数据部分的开始扇区号|
>> |分区实际结束扇区号|8字节|当前分区数据部分的结束扇区号|
>> |分区块数|4字节|用于记录当前分区中的簇数|
>> |分区位图组数|4字节|用于记录当前分区中位图组数，方便索引|
>> |分区位图组块表|4字节×n|用于记录位图中的**可用块数**和**已用块数**（大小不固定，根据实际分区大小决定）|
>> |加密状态|384字节|用于记录当前分区的数据的加密密钥摘要（本摘要不作为加密密钥）|  
>> |启动项扇区号|8字节|用于记录当前分区的启动项位置（当前为保留项）|  
>> |用户表|8092字节|用于保存分区的用户表，共256个项，每项32字节，使用摘要形式保存，对应用户ID，每一个位与之后的安全性对应|
>> |安全性|512字节|用于标识分区的访问性，总共包含256个项目，以表的形式存在，每一项包含**允许**与**阻止**两个项目，每个项目包含8个具体的**操作**，每个操作占用1bit|
>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

> ***分区位图***  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分区位图用于标识当前分区中的所有块的使用状态，分区位图采用分组策略。每一组包含32,768个块，占用4KB的大小。每个分区位图组包含一个**可用块数**和**已用块数**记录区，每个占用2字节，共4字节。分区位图采用4KB对齐，不计算在分区的实际大小中。  

> ***分区块***  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPF分区块包含MFR块、间接索引块和数据块三种，以块的前4字节为标识，如下表所示。  
>> |块类型|值|说明|
>> |:-:|:-:|:-:|
>> |MFR块|`{0x4D,0x46,0x52,0x30}`|用于表明当前块是MFR块|
>> |间接索引块|`{0x49,0x4E,0x44,0x30}`|用于表明当前块用于间接寻址，当中的数据为间接寻址数据|
>> |数据块|`{0x44,0x41,0x54,0x41}`|用于表明当前的块为数据块，不进行寻址操作|  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

> ***MFR*** *（Main Files Record）*  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MFR（主文件记录）借鉴于NTFS，用于记录当前分区中（联合分区中）的所有文件信息，每个项目占用约1024字节的空间（除掉4字节头和寻址链后剩余块空间的平分，实际MFR项大小会小于1024字节），MFR使用MFR块进行保存，占用分区储存空间。下表所示为MFR项目的基本结构。  
>> |字段|大小|说明|
>> |:-:|:-:|:--|
>> |父级索引号|6字节|用于标识当前文件/文件夹的父类目录，用于建立分区结构|
>> |文件ID|16字节|用于标识当前文件的ID（文件夹时为空）|
>> |创建时间|8字节|用于标识文件/文件夹的创建时间|
>> |修改时间|8字节|用于标识文件/文件夹的修改时间|
>> |访问时间|8字节|用于标识文件/文件夹的访问时间|
>> |属性|8字节|用于标识文件的隐含属性，包括当前项目是文件还是文件夹以及当前文件的数据保存在MFR还是通过寻址|
>> |安全性|512字节|用于标识文件的访问性，总共包含256个项目，以表的形式存在，每一项包含**允许**与**阻止**两个项目，每个项目包含8个具体的**操作**，每个操作占用1bit|
>> |文件大小|8字节|用于标识文件的实际大小|
>> |文件块数|4字节|用于标识文件的占用块数|
>> |文件名|256字节||
>> |寻址空间|186字节|采用B+树保存，root根部拥有31个寻址指针，最多拥有3级寻址|  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

> ***寻址块***  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;寻址块用于当文件大于`簇大小×31`时使用，除头4字节为标识位外，其他空间都为寻址指针。寻址指针具体数目与簇大小关系如下表。
>> |簇大小（KB）|寻址块指针数|
>> |:-:|:-:|
>> |4|682|
>> |8|1364|
>> |16|2730|
>> |32|5460|
>> |64|10922|
>> |128|21844|
>> |256|43690|
>> |512|87380|
>> |1024|174762|
>> |2048|349524|
>> |4096|699050|  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

> ***数据块***  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数据块用于保存实际的数据，其中当文件小于160Bytes时，不分配多余的空间，直接使用MFR进行保存，当大于160Bytes时，将会分配数据块进行保存。数据块为了保证数据的安全，将会对每一个块保存文件基本信息，保证可以通过扫描块进行重建。下表为数据块的结构。
>> |字段|大小|说明|
>> |:-:|:-:|:--|
>> |标识符|4字节|用于标识块为数据块|
>> |文件ID|16字节|用于对同文件的块进行标识|
>> |文件索引|4字节|用于标识当前块在整个文件块中的位置|
>> |Data|簇大小-24Bytes|数据存放区|  
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

> ***TYPF簇与空间对应表***  
>> |单个分区大小（TB）|联合分区大小（EB）|最大单个文件（TB）|最大文件损耗（GB）|损耗比例（‰）|
>> |:-:|:-:|:-:|:-:|:-:|
>> |16|1|36|54.132164|1.4684289279911300| 
>> |32|2|584|438.7498245|0.7336757286158330| 
>> |64|4|9383|3520.773926|0.3664345930827830| 
>> |128|8|150260|28185.79233|0.1831837336629590| 
>> |256|16|2406445|225638.6485|0.0915667063549554| 
>> |512|32|33554432|1573032.018|0.0457812571639238| 
>> |1024|64|67108864|1572924.003|0.0228890567477436| 
>> |2048|128|134217728|1572906.002|0.0114443974013057| 
>> |4096|256|268435456|1572879.003|0.0057221004787778| 
>> |8192|512|536870912|1572874.506|0.0028610420592656|
>> |16384|1024|1073741824|1572867.762|0.0014305148958727| 
